<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Particles</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      #tsparticles {
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="tsparticles"></div>

    <script src="tsparticles.bundle.js"></script>
    <script>
  // --- ▽ 設定1：膠着状態 (Stalemate) ▽ ---
  const stalemateOptions = {
    fpsLimit: 30,
    particles: {
      number: {
        value: 15, // ▼ 数を調整 (100 -> 15)
        density: { enable: true },
      },
      color: { value: "#ffd700" },
      shape: { type: "circle" },
      opacity: { value: 0.5 },
      size: { value: { min: 40, max: 200 } }, // ▼ サイズを変更
      move: {
        enable: true,
        speed: 15,
        direction: "none",
        random: true,
        straight: false,
        out_mode: "bounce",
      },
    },
  };

  // --- ▽ 設定2：攻撃時 (Attacking) ▽ ---
  const attackingOptions = {
    fpsLimit: 30,
    particles: {
      number: {
        value: 20, // ▼ 数を調整 (80 -> 10)
        density: { enable: true },
      },
      color: { value: "#ff0000" },
      shape: { type: "circle" },
      opacity: { value: 0.4 },
      size: { value: { min: 40, max: 200 } }, // ▼ サイズを変更
      move: {
        enable: true,
        speed: 45,
        direction: "none",
        random: true,
        straight: false,
        out_mode: "bounce",
      },
    },
  };

  // --- ▽ 設定3：防御時 (Defending) ▽ ---
  const defendingOptions = {
    fpsLimit: 30,
    particles: {
      number: {
        value: 30, // ▼ 数を調整 (80 -> 10)
        density: { enable: true },
      },
      color: { value: "#00bfff" },
      shape: { type: "triangle" },
      opacity: { value: 0.6 },
      size: { value: { min: 40, max: 200 } }, // ▼ サイズを変更
      links: {
        enable: true,
        distance: 250, // 距離も調整
        color: "#87cefa",
        opacity: 0.4,
        width: 1,
      },
      move: {
        enable: true,
        speed: 30,
        direction: "none",
        random: true,
        straight: false,
        out_mode: "bounce",
      },
    },
  };

      (async () => {
        await loadFull(tsParticles);

        // --- 状態管理 ---
        const animationOrder = ["Stalemate", "ScoringAttempt", "GoalDefense"];
        let animationIndex = 0;
        let activeAnimation = "Stalemate";
        let targetAnimation = "Stalemate";
        let lockTimeout = null;

        await tsParticles.load({
          id: "tsparticles",
          options: stalemateOptions,
        });

        // クリックで切り替え
        document.getElementById("tsparticles").addEventListener("click", () => {
          if (lockTimeout) return;
          animationIndex = (animationIndex + 1) % animationOrder.length;
          targetAnimation = animationOrder[animationIndex];
          attemptToUpdateAnimation(true);
        });

        // WebSocket
        const so = new WebSocket("ws://localhost:54834");
        so.onmessage = (msg) => {
          targetAnimation = msg.data;
          attemptToUpdateAnimation(false);
        };

        // アニメーション切り替え
        function attemptToUpdateAnimation(isManual) {
          if (lockTimeout) return;
          if (targetAnimation === activeAnimation) return;

          let options;
          let duration = 2000;
          switch (targetAnimation) {
            case "ScoringAttempt":
              options = attackingOptions;
              duration = 2000;
              break;
            case "GoalDefense":
              options = defendingOptions;
              duration = 2000;
              break;
            default:
              options = stalemateOptions;
              break;
          }
          tsParticles.load({ id: "tsparticles", options });
          activeAnimation = targetAnimation;
          if (duration > 0) {
            lockTimeout = setTimeout(() => {
              lockTimeout = null;
              attemptToUpdateAnimation(false);
            }, duration);
          }
        }
      })();
    </script>
  </body>
</html>
